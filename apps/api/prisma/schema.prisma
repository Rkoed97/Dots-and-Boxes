// Prisma schema for Dots & Boxes API
// Provider: PostgreSQL, aligned with docker-compose (db service)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum MatchStatus {
  waiting
  active
  finished
  abandoned
}

enum EdgeOrientation {
  H
  V
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  username     String         @unique
  passwordHash String
  createdAt    DateTime       @default(now())

  // Relations
  settings       UserSettings?
  sessions       Session[]
  matchesCreated Match[]      @relation("MatchesCreated")
  matchesX       Match[]      @relation("PlayerXMatches")
  matchesO       Match[]      @relation("PlayerOMatches")
  matchesWon     Match[]      @relation("MatchesWon")
  moves          MatchMove[]
}

model UserSettings {
  userId String  @id
  theme  Json

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Match {
  id          String       @id @default(uuid())
  status      MatchStatus  @default(waiting)
  n           Int
  m           Int
  createdAt   DateTime     @default(now())
  finishedAt  DateTime?

  // Relations
  createdBy   User         @relation("MatchesCreated", fields: [createdById], references: [id])
  createdById String

  playerX     User?        @relation("PlayerXMatches", fields: [playerXId], references: [id])
  playerXId   String?

  playerO     User?        @relation("PlayerOMatches", fields: [playerOId], references: [id])
  playerOId   String?

  winner      User?        @relation("MatchesWon", fields: [winnerId], references: [id])
  winnerId    String?

  moves       MatchMove[]

  @@index([status])
  @@index([createdById])
  @@index([playerXId])
  @@index([playerOId])
  @@index([winnerId])
}

model MatchMove {
  id               String          @id @default(uuid())
  match            Match           @relation(fields: [matchId], references: [id], onDelete: Cascade)
  matchId          String
  player           User            @relation(fields: [playerId], references: [id])
  playerId         String
  edgeOrientation  EdgeOrientation
  edgeRow          Int
  edgeCol          Int
  createdAt        DateTime        @default(now())

  @@index([matchId, createdAt])
  @@index([playerId])
}

model Session {
  id        String   @id
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}
